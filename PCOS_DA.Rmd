---
title: "Анализ данных ген.экспрессии гранулезных клеток при СПКЯ"
author: "Игорь Буланов"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Анализ ген.экспресии 


```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(DESeq2)
```
## Анализ данных исследования GSE173160
```{r, echo = FALSE}
cts <- read_delim("/home/ibulanov/data/PCOS/GEO/GSE173160_gene_count_matrix.txt.gz")
cts <- cts[,-c(2:13)]
cts <- column_to_rownames(cts, var = "lncRNA_id")
colnames(cts) <- gsub("^1_", "", colnames(cts))

#first 6 are PCOS, the last 6 are CONTROLS
samples <- c("95784_count", 
             "95841_count", 
             "96846_count",
             "97194_count",
             "97477_count",
             "97550_count",
             "92393_count",
             "96349_count",
             "96412_count",
             "96725_count",
             "97232_count",
             "97371_count"
             )

#reoder columns
cts <- cts[,samples]

coldata <- data.frame(batch = samples, condition = 
                        c(rep("PCOS", 6),
                          rep("CONTROL", 6)
                          ))

#replace NAs (133) in 97371 sample to 0s
cts[is.na(cts)] = 0

dds <- DESeqDataSetFromMatrix(countData = cts,
                              colData = coldata,
                              design= ~condition)

```

# Exploratory analysis and visualization
## Pre-filtering the dataset
```{r}
nrow(dds)
keep <- rowSums(counts(dds)) > 1
dds <- dds[keep,]
nrow(dds)
```

##The variance stabilizing transformation and the rlog
```{r, echo=FALSE}
vsd <- vst(dds, blind = FALSE)
head(assay(vsd), 3)

rld <- rlog(dds, blind = FALSE)
head(assay(rld), 3)

colData(vsd)

library("dplyr")
library("ggplot2")

dds <- estimateSizeFactors(dds)

df <- bind_rows(
  as_tibble(log2(counts(dds, normalized=TRUE)[, 1:2]+1)) %>%
         mutate(transformation = "log2(x + 1)"),
  as_tibble(assay(vsd)[, 1:2]) %>% mutate(transformation = "vst"),
  as_tibble(assay(rld)[, 1:2]) %>% mutate(transformation = "rlog"))
  
colnames(df)[1:2] <- c("x", "y")  

lvls <- c("log2(x + 1)", "vst", "rlog")
df$transformation <- factor(df$transformation, levels=lvls)

ggplot(df, aes(x = x, y = y)) + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation)  
```
## Sample distances


